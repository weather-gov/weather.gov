<?php

use Drupal\Core\Form\FormStateInterface;

// This hook allows us to alter single elements of a widget, which we want to do for alt text on uploaded images
function weather_cms_field_widget_single_element_form_alter(array &$element, FormStateInterface $form_state, array $context) // phpcs:ignore
{
    if ($context["widget"] instanceof \Drupal\image\Plugin\Field\FieldWidget\ImageWidget) {
        $element["#process"][] = "weather_cms_image_field_widget_process";
    }
}

function weather_cms_image_field_widget_process($element, &$form_state, $form)
{
    if (isset($element["alt"])) {
        $element["alt"]["#description"] = "Alt text should provide the same information as the image, not serve as a description of the image itself. If you have included text on your image, it should be in the alt text along with whatever additional context is needed to provide the same information to users who cannot view the image."; // phpcs:ignore
    }
    return $element;
}

/**
 * Alter the list of timezones available when
 * a user is created or updated
 *
 */
function weather_cms_form_alter(&$form, FormStateInterface $form_state, $form_id)
{

    if($form_id == 'user_register_form' || $form_id == 'user_profile_form'){
        $form['#after_build'][] = 'weather_cms_form_adjust_timezones';
    }
}

function weather_cms_form_adjust_timezones($form, &$form_state)
{
    $ABBREVS_TO_LONGNAME = [
        "AKDT" => "Alaska Daylight Time",
        "AKST" => "Alaska Standard Time",
        "HDT" => "Hawaii–Aleutian Daylight Time",
        "HST" => "Hawaii–Aleutian Standard Time",
        "MDT" => "Mountain Daylight Time",
        "MST" => "Mountain Standard Time",
        "CDT" => "Central Daylight Time",
        "CST" => "Central Standard Time",
        "EDT" => "Eastern Daylight Time",
        "EST" => "Eastern Standard Time",
        "PDT" => "Pacific Daylight Time",
        "PST" => "Pacific Standard Time",
        // More to do
    ];
    $us_timezone_ids = \DateTimeZone::listIdentifiers(\DateTimeZone::PER_COUNTRY, "US");
    $utc = new \DateTime("now", new \DateTimeZone("UTC"));
    $abbrevs = [];
    $zone_info = array_map(
        function($timezone_id) use (&$utc, &$abbrevs){
            $timezone = new \DateTimeZone($timezone_id);
            $abbrev = (new \DateTime("now", $timezone))->format("T");
            $abbrevs[] = $abbrev;
            return [
                "id" => $timezone_id,
                "label" => $timezone_id,
                "name" => $timezone->getName(),
                "abbrev" => $abbrev,
                "utc_offset" => ($timezone->getOffset($utc) / 60) / 60
            ];
        },
        $us_timezone_ids
    );
    $abbrevs = array_unique($abbrevs);
    // Something here!
}
