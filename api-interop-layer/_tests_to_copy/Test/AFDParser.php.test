<?php

namespace Drupal\weather_data\Service\Test;

use Drupal\weather_data\Service\AFDParser;
use PHPUnit\Framework\TestCase;

final class AFDParserTest extends TestCase
{
    /**
     * @group unit
     * @group afd-parser
     */
    public function testBasicHeaderAndText(): void
    {
        $raw = ".SYNOPSIS...\n";
        $raw .=
            "A nearly stationary front will remain near the coast through\n";
        $raw .=
            "Thursday. The front will then return northward Thursday night\n";
        $raw .= "into Friday.\n";

        $expected = [
            [
                "type" => "header",
                "content" => "SYNOPSIS"
            ],
            [
                "type" => "text",
                "content" =>
                    "A nearly stationary front will remain near the coast through" .
                           " Thursday. The front will then return northward Thursday night into Friday.",
            ],
        ];

        $parser = new AFDParser($raw);
        $actual = $parser->parse();

        $this->assertEquals($expected, $actual);
    }

    /**
     * @group unit
     * @group afd-parser
     */
    public function testHeaderWithoutNewline(): void
    {
        $source = ".SPOTTER INFORMATION STATEMENT...";
        $expected = [
            [
                "type" => "header",
                "content" => "SPOTTER INFORMATION STATEMENT"
            ],
        ];

        $parser = new AFDParser($source);
        $actual = $parser->parse();

        $this->assertEquals($expected, $actual);
    }

    /**
     * @group unit
     * @group afd-parser
     */
    public function testHeaderWithPostheader(): void
    {
        $raw =
            ".AVIATION /15Z WEDNESDAY THROUGH SUNDAY/...SOME OTHER TEXT HERE\n";
        $raw .=
            "Improvement to MVFR cigs by mid-morning for any sites that are\n";
        $raw .=
            "not already MVFR. Slow improvement then to VFR starting from the\n";
        $raw .=
            "north in the late afternoon and reaching the NYC terminals late\n";
        $raw .= "this evening.\n";

        $expected = [
            [
                "type" => "header",
                "content" => "AVIATION /15Z WEDNESDAY THROUGH SUNDAY/"
            ],
            [
                "type" => "text",
                "content" =>
                    "SOME OTHER TEXT HERE Improvement to MVFR cigs by mid-morning for any sites " .
                           "that are not already MVFR. Slow improvement then to " .
                           "VFR starting from the north in the late afternoon and " .
                           "reaching the NYC terminals late this evening.",
            ],
        ];

        $parser = new AFDParser($raw);
        $actual = $parser->parse();

        $this->assertEquals($expected, $actual);
    }

    /**
     * @group unit
     * @group afd-parser
     */
    public function testBasicSubheader(): void
    {
        $raw = " ...NY Metro (KEWR/KLGA/KJFK/KTEB) TAF Uncertainty...";

        $expected = [
            [
                "type" => "subheader",
                "content" => "NY Metro (KEWR/KLGA/KJFK/KTEB) TAF Uncertainty",
            ],
        ];

        $parser = new AFDParser($raw);
        $actual = $parser->parseParagraph($raw);

        $this->assertEquals($expected, $actual);
    }

    /**
     * @group unit
     * @group afd-parser
     */
    public function testBasicPreamble(): void
    {
        $raw = "000\n";
        $raw .= "FXUS61 KOKX 071443\n";
        $raw .= "AFDOKX\n";
        $raw .= "\n";
        $raw .= "Area Forecast Discussion\n";
        $raw .= "National Weather Service New York NY\n";
        $raw .= "1043 AM EDT Wed Aug 7 2024\n";
        $raw .= "\n";

        $expected = [
            [
                "type" => "preambleCode",
                "content" => "000\nFXUS61 KOKX 071443\nAFDOKX",
            ],
            [
                "type" => "preambleText",
                "content" =>
                    "Area Forecast Discussion\nNational Weather Service New York NY\n1043 AM EDT Wed Aug 7 2024",
            ],
        ];

        $parser = new AFDParser($raw);
        $actual = $parser->parse();

        $this->assertEquals($expected, $actual);
    }

    /**
     * @group unit
     * @group afd-parser
     */
    public function testParsingFullExample(): void
    {
        $raw = "\n";
        $raw .= "000\n";
        $raw .= "FXUS61 KOKX 071443\n";
        $raw .= "AFDOKX\n";
        $raw .= "\n";
        $raw .= "Area Forecast Discussion\n";
        $raw .= "National Weather Service New York NY\n";
        $raw .= "1043 AM EDT Wed Aug 7 2024\n";
        $raw .= "\n";
        $raw .= ".SYNOPSIS...\n";
        $raw .=
            "A nearly stationary front will remain near the coast through \n";
        $raw .=
            "Thursday. The front will then return northward Thursday night\n";
        $raw .= "into Friday. \n";
        $raw .= "\n";
        $raw .=
            "Please refer to the latest official forecast on Debby from the \n";
        $raw .= "National Hurricane Center.\n";
        $raw .= "\n";
        $raw .= "&&\n";
        $raw .= "\n";
        $raw .= ".NEAR TERM /THROUGH TONIGHT/...\n";
        $raw .=
            "Forecast mainly on track. Much cooler air mass has worked into the \n";
        $raw .= "region with the stationary front just of the of the area.\n";
        $raw .= "\n\n ...NY Metro (KEWR/KLGA/KJFK/KTEB) TAF Uncertainty...\n";
        $raw .=
            "High pressure builds down from the north into tonight, which will \n";
        $raw .=
            "only reinforce some of the lower level cooler and drier air. \n";
        $raw .= "\n";
        $raw .= ".OKX WATCHES/WARNINGS/ADVISORIES...\n";
        $raw .= "CT...None.\n";
        $raw .= "NY...None.\n";
        $raw .= "NJ...None.\n";
        $raw .=
            "MARINE...Small Craft Advisory until 11 PM EDT this evening for ANZ350-\n";
        $raw .= "                353-355.\n";
        $raw .= "\n";
        $raw .= "            &&\n";
        $raw .= "\n";
        $raw .= "                $$\n";
        $raw .= "\n";
        $raw .= "        SYNOPSIS...JT/DW\n";
        $raw .= "        NEAR TERM...DS/DW\n";
        $raw .= "        SHORT TERM...DW\n";
        $raw .= "        LONG TERM...JT\n";
        $raw .= "        MARINE...JT/DW \n";
        $raw .= "        HYDROLOGY...JT/DW \n";
        $raw .= "        TIDES/COASTAL FLOODING...\n";

        $expected = [
            [
                "type" => "preambleCode",
                "content" => "000\nFXUS61 KOKX 071443\nAFDOKX",
            ],
            [
                "type" => "preambleText",
                "content" =>
                    "Area Forecast Discussion\nNational Weather Service New York NY\n1043 AM EDT Wed Aug 7 2024",
            ],
            [
                "type" => "header",
                "content" => "SYNOPSIS",
            ],
            [
                "type" => "text",
                "content" =>
                    "A nearly stationary front will remain near the coast through" .
                           " Thursday. The front will then return northward Thursday night into Friday.",
            ],
            [
                "type" => "text",
                "content" =>
                    "Please refer to the latest official forecast on Debby from the National Hurricane Center.",
            ],
            [
                "type" => "header",
                "content" => "NEAR TERM /THROUGH TONIGHT/"
            ],
            [
                "type" => "text",
                "content" =>
                    "Forecast mainly on track. Much cooler air mass has worked into the " .
                           "region with the stationary front just of the of the area.",
            ],
            [
                "type" => "subheader",
                "content" => "NY Metro (KEWR/KLGA/KJFK/KTEB) TAF Uncertainty",
            ],
            [
                "type" => "text",
                "content" =>
                    "High pressure builds down from the north into tonight, which will " .
                           "only reinforce some of the lower level cooler and drier air.",
            ],
            [
                "type" => "header",
                "content" =>
                    "OKX WATCHES&hairsp;/&hairsp;WARNINGS&hairsp;/&hairsp;ADVISORIES"
            ],
            [
                "type" => "text",
                "content" =>
                    "CT...None.\nNY...None.\nNJ...None.\nMARINE" .
                           "...Small Craft Advisory until 11 PM EDT " .
                           "this evening for ANZ350-353-355.",
            ],
            [
                "type" => "epilogueText",
                "content" =>
                    "SYNOPSIS...JT/DW\nNEAR TERM...DS/DW\nSHORT" .
                           " TERM...DW\nLONG TERM...JT\nMARINE..." .
                           "JT/DW\nHYDROLOGY...JT/DW\nTIDES/COASTAL FLOODING...",
            ],
        ];

        $parser = new AFDParser($raw);
        $actual = $parser->parse();

        $this->assertEquals($expected, $actual);
    }

    /**
     * @group unit
     * @group afd-parser
     */
    public function testPOPsTable(): void
    {
        $raw = "Place A   1 2 3 4 / 5 6 7 8
                Place B   0 9  8 7 / 6   5 4  3";
        // Remove leading spaces on test data.
        $raw = preg_replace("/^\s*/m", "", $raw);

        $expected = [
            [
                "type" => "temps-table",
                "rows" => [
                    [
                        "type" => "temps-table-row",
                        "numbers" => ["1", "2", "3", "4", "5", "6", "7", "8"],
                        "name" => "Place A",
                    ],
                    [
                        "type" => "temps-table-row",
                        "numbers" => ["0", "9", "8", "7", "6", "5", "4", "3"],
                        "name" => "Place B",
                    ],
                ],
            ],
        ];

        $parser = new AFDParser($raw);
        $actual = [];
        $parser->parseTempsTableContent($raw, $actual);

        $this->assertEquals($expected, $actual);
    }

    /**
     * @group unit
     * @group afd-parser
     * @group unit2
     */
    public function testPOPsTableWithLeadingNewline(): void
    {
        $raw = "Place A   1 2 3 4 / 5 6 7 8
                Place B   0 9  8 7 / 6   5 4  3";
        // Remove leading spaces on test data.
        $raw = preg_replace("/^\s*/m", "", $raw);
        // Put in a leading newline.
        $raw = "\n$raw";

        $expected = [
            [
                "type" => "temps-table",
                "rows" => [
                    [
                        "type" => "temps-table-row",
                        "numbers" => ["1", "2", "3", "4", "5", "6", "7", "8"],
                        "name" => "Place A",
                    ],
                    [
                        "type" => "temps-table-row",
                        "numbers" => ["0", "9", "8", "7", "6", "5", "4", "3"],
                        "name" => "Place B",
                    ],
                ],
            ],
        ];

        $parser = new AFDParser($raw);
        $actual = [];
        $parser->parseTempsTableContent($raw, $actual);

        $this->assertEquals($expected, $actual);
    }

    /**
     * @group unit
     * @group afd-parser
     */
    public function testGetStructureForTwig(): void
    {
        $raw = "\n";
        $raw .= "000\n";
        $raw .= "FXUS61 KOKX 071443\n";
        $raw .= "AFDOKX\n";
        $raw .= "\n";
        $raw .= "Area Forecast Discussion\n";
        $raw .= "National Weather Service New York NY\n";
        $raw .= "1043 AM EDT Wed Aug 7 2024\n";
        $raw .= "\n";
        $raw .= ".SYNOPSIS...\n";
        $raw .=
            "A nearly stationary front will remain near the coast through \n";
        $raw .=
            "Thursday. The front will then return northward Thursday night\n";
        $raw .= "into Friday. \n";
        $raw .= "\n";
        $raw .=
            "Please refer to the latest official forecast on Debby from the \n";
        $raw .= "National Hurricane Center.\n";
        $raw .= "\n";
        $raw .= "&&\n";
        $raw .= "\n";
        $raw .= ".NEAR TERM /THROUGH TONIGHT/...\n";
        $raw .=
            "Forecast mainly on track. Much cooler air mass has worked into the \n";
        $raw .= "region with the stationary front just of the of the area.\n";
        $raw .= "\n\n ...NY Metro (KEWR/KLGA/KJFK/KTEB) TAF Uncertainty...\n";
        $raw .=
            "High pressure builds down from the north into tonight, which will \n";
        $raw .=
            "only reinforce some of the lower level cooler and drier air. \n";
        $raw .= "\n";
        $raw .= ".OKX WATCHES/WARNINGS/ADVISORIES...\n";
        $raw .= "CT...None.\n";
        $raw .= "NY...None.\n";
        $raw .= "NJ...None.\n";
        $raw .=
            "MARINE...Small Craft Advisory until 11 PM EDT this evening for ANZ350-\n";
        $raw .= "                353-355.\n";
        $raw .= "\n";
        $raw .= "            &&\n";
        $raw .= "\n";
        $raw .= "                $$\n";
        $raw .= "\n";
        $raw .= "        SYNOPSIS...JT/DW\n";
        $raw .= "        NEAR TERM...DS/DW\n";
        $raw .= "        SHORT TERM...DW\n";
        $raw .= "        LONG TERM...JT\n";
        $raw .= "        MARINE...JT/DW \n";
        $raw .= "        HYDROLOGY...JT/DW \n";
        $raw .= "        TIDES/COASTAL FLOODING...\n";

        $expected = [
            "preamble" => [
                "code" => [
                    [
                        "type" => "preambleCode",
                        "content" => "000\nFXUS61 KOKX 071443\nAFDOKX",
                    ],
                ],
                "text" => [
                    [
                        "type" => "preambleText",
                        "content" =>
                            "Area Forecast Discussion\nNational Weather Service " .
                                   "New York NY\n1043 AM EDT Wed Aug 7 2024",
                    ],
                ],
            ],
            "body" => [
                [
                    "type" => "header",
                    "content" => "SYNOPSIS"
                ],
                [
                    "type" => "text",
                    "content" =>
                        "A nearly stationary front will remain near the coast through" .
                               " Thursday. The front will then return northward Thursday night into Friday.",
                ],
                [
                    "type" => "text",
                    "content" =>
                        "Please refer to the latest official forecast on Debby from the National Hurricane Center.",
                ],
                [
                    "type" => "header",
                    "content" => "NEAR TERM /THROUGH TONIGHT/"
                ],
                [
                    "type" => "text",
                    "content" =>
                        "Forecast mainly on track. Much cooler air mass has worked into the " .
                               "region with the stationary front just of the of the area.",
                ],
                [
                    "type" => "subheader",
                    "content" =>
                        "NY Metro (KEWR/KLGA/KJFK/KTEB) TAF Uncertainty",
                ],
                [
                    "type" => "text",
                    "content" =>
                        "High pressure builds down from the north into tonight, which will " .
                               "only reinforce some of the lower level cooler and drier air.",
                ],
                [
                    "type" => "header",
                    "content" =>
                        "OKX WATCHES&hairsp;/&hairsp;WARNINGS&hairsp;/&hairsp;ADVISORIES"
                ],
                [
                    "type" => "text",
                    "content" =>
                        "CT...None.\nNY...None.\nNJ...None.\nMARINE" .
                               "...Small Craft Advisory until 11 PM EDT " .
                               "this evening for ANZ350-353-355.",
                ],
            ],
            "epilogue" => [
                [
                    "type" => "epilogueText",
                    "content" =>
                        "SYNOPSIS...JT/DW\nNEAR TERM...DS/DW\nSHORT" .
                               " TERM...DW\nLONG TERM...JT\nMARINE..." .
                               "JT/DW\nHYDROLOGY...JT/DW\nTIDES/COASTAL FLOODING...",
                ],
            ],
        ];

        $parser = new AFDParser($raw);
        $parser->parse();
        $actual = $parser->getStructureForTwig();

        $this->assertEquals($expected, $actual);
    }

    /**
     * @group unit
     * @group afd-parser
     */
    public function testConsecutiveHeaders(): void
    {
        $raw = ".NEAR TERM /UNTIL 6 PM THIS EVENING/...\n";
        $raw .= ".UPDATE...As of 630 AM EDT, patchy fog has developed within many\n";
        $raw .= "river valleys across the region, some of which was locally\n";
        $raw .= "dense. This fog will dissipate between 8 and 10 AM.";

        $expected = [
            [
                "type" => "header",
                "content" => "NEAR TERM /UNTIL 6 PM THIS EVENING/"
            ],
            [
                "type" => "header",
                "content" => "UPDATE"
            ],
            [
                "type" => "text",
                "content" =>
                    "As of 630 AM EDT, patchy fog has developed within many river valleys"
                    . " across the region, some of which was locally dense. This fog will "
                         . "dissipate between 8 and 10 AM."
            ]
        ];

        $parser = new AFDParser($raw);
        $actual = $parser->parse();

        $this->assertEquals($expected, $actual);
    }
}
